<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mingyuansoftware.aifactory.mapper.SalesOrderMapper" >
  <resultMap id="BaseResultMap" type="com.mingyuansoftware.aifactory.model.SalesOrder" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="sales_order_id" property="salesOrderId" jdbcType="INTEGER" />
    <result column="sales_order_number" property="salesOrderNumber" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="state" property="state" jdbcType="TINYINT" />
    <result column="payment_status" property="paymentStatus" jdbcType="TINYINT" />
    <result column="amount" property="amount" jdbcType="DECIMAL" />
    <result column="amount_received" property="amountReceived" jdbcType="DECIMAL" />
    <result column="outstanding_amount" property="outstandingAmount" jdbcType="DECIMAL" />
    <result column="comment" property="comment" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="is_delete" property="isDelete" jdbcType="TINYINT" />
    <result column="order_type" property="orderType" jdbcType="TINYINT" />
    <result column="add_time" property="addtime" jdbcType="DATE" />
    <result column="total_boxes_number" property="totalBoxesNumber" jdbcType="INTEGER" />
    <result column="total_amount" property="totalAmount" jdbcType="DECIMAL" />
    <result column="total_net_weight" property="totalNetWeight" jdbcType="DECIMAL" />
    <result column="total_gross_weight" property="totalGrossWeight" jdbcType="DECIMAL" />
    <result column="total_volume" property="totalVolume" jdbcType="DECIMAL" />
    <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
    <association column="staff_id" property="staff"
                 select="com.mingyuansoftware.aifactory.mapper.StaffMapper.selectByPrimaryKey"></association>
    <association column="customer_id" property="customer"
                 select="com.mingyuansoftware.aifactory.mapper.CustomerMapper.selectCustomerByCId"></association>
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from sales_order
    where sales_order_id = #{salesOrderId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.mingyuansoftware.aifactory.model.SalesOrder" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey resultType="java.lang.Integer" keyProperty="salesOrderId" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into sales_order (customer_id, sales_order_number, create_time, 
      `state`, payment_status, amount, 
      amount_received,outstanding_amount, `comment`, update_time,
      is_delete, staff_id, order_type,add_time,total_boxes_number,total_amount,
      total_net_weight,total_gross_weight,total_volume
      )
    values (#{customerId,jdbcType=INTEGER}, #{salesOrderNumber,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{state,jdbcType=TINYINT}, #{paymentStatus,jdbcType=TINYINT}, #{amount,jdbcType=DECIMAL},
    #{amountReceived,jdbcType=DECIMAL},#{outstandingAmount,jdbcType=DECIMAL}, #{comment,jdbcType=VARCHAR}, #{updateTime,jdbcType=TIMESTAMP},
      #{isDelete,jdbcType=TINYINT}, #{staffId,jdbcType=INTEGER}, #{orderType,jdbcType=TINYINT},#{addtime,jdbcType=DATE},
      #{totalBoxesNumber,jdbcType=INTEGER},#{totalAmount,jdbcType=DECIMAL},
      #{totalNetWeight,jdbcType=DECIMAL},#{totalGrossWeight,jdbcType=DECIMAL},#{totalVolume,jdbcType=DECIMAL}
      )
  </insert>
  <update id="updateByPrimaryKey" parameterType="com.mingyuansoftware.aifactory.model.SalesOrder" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sales_order
    set customer_id = #{customerId,jdbcType=INTEGER},
      sales_order_number = #{salesOrderNumber,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      `state` = #{state,jdbcType=TINYINT},
      payment_status = #{paymentStatus,jdbcType=TINYINT},
      amount = #{amount,jdbcType=DECIMAL},
      amount_received = #{amountReceived,jdbcType=DECIMAL},
    outstanding_amount = #{outstandingAmount,jdbcType=DECIMAL},
      `comment` = #{comment,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      is_delete = #{isDelete,jdbcType=TINYINT},
      staff_id = #{staffId,jdbcType=INTEGER},
      order_type = #{orderType,jdbcType=TINYINT},
      add_time = #{addtime,jdbcType=DATE},
      total_boxes_number = #{totalBoxesNumber,jdbcType=INTEGER},
      total_amount = #{totalAmount,jdbcType=DECIMAL},
      total_net_weight = #{totalNetWeight,jdbcType=DECIMAL},
      total_gross_weight =#{totalGrossWeight,jdbcType=DECIMAL},
      total_volume = #{totalVolume,jdbcType=DECIMAL}
    where sales_order_id = #{salesOrderId,jdbcType=INTEGER}
  </update>

  <update id="updateBySaleNumber" parameterType="com.mingyuansoftware.aifactory.model.SalesOrder" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sales_order
    set
    payment_status = #{paymentStatus,jdbcType=TINYINT},

    amount_received = #{amountReceived,jdbcType=DECIMAL},
    outstanding_amount = #{outstandingAmount,jdbcType=DECIMAL},
    update_time = #{updateTime,jdbcType=TIMESTAMP}

    where sales_order_number = #{salesOrderNumber,jdbcType=VARCHAR}
  </update>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select sales_order_id, customer_id, sales_order_number, create_time, `state`, payment_status, 
    amount, amount_received, `comment`, update_time, is_delete, staff_id, order_type,add_time,total_boxes_number,total_amount,
    total_net_weight,total_gross_weight,total_volume
    from sales_order
    where sales_order_id = #{salesOrderId,jdbcType=INTEGER}
  </select>

    <select id="selectByCustomerId" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select sales_order_id, customer_id, sales_order_number,
        amount, amount_received,outstanding_amount
        from sales_order
        where customer_id = #{customerId,jdbcType=INTEGER} and is_delete=0
    </select>

  <select id="selectByCustomerId1" resultType="com.mingyuansoftware.aifactory.model.SalesOrder" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select sales_order_id, so.customer_id, sales_order_number,
    amount, amount_received,outstanding_amount,c.write_off_amount
    from sales_order so left JOIN customer c ON c.customer_id=so.customer_id
    where so.customer_id = #{customerId,jdbcType=INTEGER} and so.is_delete=0 AND  so.payment_status != 3
  </select>

  <select id="selectAll" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select sales_order_id, customer_id, sales_order_number, create_time, `state`, payment_status, 
    amount, amount_received, `comment`, update_time, is_delete, staff_id, order_type,add_time,total_boxes_number,total_amount,
    total_net_weight,total_gross_weight,total_volume
    from sales_order
  </select>


  <select id="selectSalesOrderList" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select so.sales_order_id, so.customer_id, so.sales_order_number, so.create_time, so.`state`, so.payment_status,
    IFNULL(so.amount,0) AS amount, IFNULL(so.amount_received,0) AS amount_received, so.outstanding_amount, so.`comment`,
    so.update_time, so.is_delete, so.staff_id, so.order_type,cr.customer_name,so.add_time
    from sales_order AS so
    left join customer as cr ON (so.customer_id =cr.customer_id)
    <where>
      <if test="salesOrderDto.salesOrderNumber != null and salesOrderDto.salesOrderNumber != ''">
        AND so.sales_order_number like "%"#{salesOrderDto.salesOrderNumber}"%"
      </if>
      <if test="salesOrderDto.addTime != null and salesOrderDto.addTime != ''">
        AND so.add_time like "%"#{salesOrderDto.addTime}"%"
      </if>
      <if test="salesOrderDto.customerName != null and salesOrderDto.customerName  != ''">
        AND cr.customer_name like "%"#{salesOrderDto.customerName }"%"
      </if>
      <if test="salesOrderDto.state != null and salesOrderDto.state != ''">
        AND  so.`state` = #{salesOrderDto.state}
      </if>
      <if test="salesOrderDto.paymentStatus != null and salesOrderDto.paymentStatus  != ''">
        AND so.payment_status = #{salesOrderDto.paymentStatus}
      </if>
      <if test="salesOrderDto.amount != null and salesOrderDto.amount  != '' or salesOrderDto.amount == '0'.toString()">
        AND so.amount = #{salesOrderDto.amount}
      </if>
      <if test="salesOrderDto.amountReceived != null and salesOrderDto.amountReceived  != ''">
        AND so.amount_received  = #{salesOrderDto.amountReceived}
      </if>
      <if test="salesOrderDto.comment != null and salesOrderDto.comment  != ''">
        AND so.`comment` like "%"#{salesOrderDto.comment}"%"
      </if>
      AND so.is_delete = 0
    </where>
    ORDER BY so.sales_order_id DESC
  </select>

  <select id="selectSalesOrderCount" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select count(so.sales_order_id)
    from sales_order AS so
    left join customer as cr ON (so.customer_id =cr.customer_id)
    <where>
      <if test="salesOrderDto.salesOrderNumber != null and salesOrderDto.salesOrderNumber != ''">
        AND so.sales_order_number like "%"#{salesOrderDto.salesOrderNumber}"%"
      </if>
      <if test="salesOrderDto.addTime != null and salesOrderDto.addTime != ''">
        AND so.add_time like "%"#{salesOrderDto.addTime}"%"
      </if>
      <if test="salesOrderDto.customerName != null and salesOrderDto.customerName  != ''">
        AND cr.customer_name like "%"#{salesOrderDto.customerName }"%"
      </if>
      <if test="salesOrderDto.state != null and salesOrderDto.state != ''">
        AND  so.`state` = #{salesOrderDto.state}
      </if>
      <if test="salesOrderDto.paymentStatus != null and salesOrderDto.paymentStatus  != ''">
        AND so.payment_status = #{salesOrderDto.paymentStatus}
      </if>
      <if test="salesOrderDto.amount != null and salesOrderDto.amount  != '' or salesOrderDto.amount == '0'.toString()">
        AND so.amount = #{salesOrderDto.amount}
      </if>
      <if test="salesOrderDto.amountReceived != null and salesOrderDto.amountReceived  != ''">
        AND so.amount_received  = #{salesOrderDto.amountReceived}
      </if>
      <if test="salesOrderDto.comment != null and salesOrderDto.comment  != ''">
        AND so.`comment` like "%"#{salesOrderDto.comment}"%"
      </if>
      AND so.is_delete = 0
    </where>
    ORDER BY so.sales_order_id DESC
  </select>

  <update id="updateSalesOrderById" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sales_order
    set
    update_time = now(),
    is_delete = 1
    where sales_order_id = #{salesOrderId,jdbcType=INTEGER}
  </update>

  <select id="selectSalesOrderById" resultMap="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select sales_order_id, customer_id, sales_order_number, create_time, `state`, payment_status,
    IFNULL(amount,0) AS amount, amount_received, `comment`, update_time, is_delete, staff_id, order_type,add_time,
    total_boxes_number,total_amount,total_net_weight,total_gross_weight,total_volume
    from sales_order
    where sales_order_id = #{salesOrderId}
  </select>

  <select id="selectLastId" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    SELECT @@IDENTITY
  </select>

  <select id="selectPdaOutboundGoodsTaskList" resultType="com.mingyuansoftware.aifactory.model.PdaOutBoundGoodsTask" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select so.sales_order_id,so.sales_order_number,sod.lot_number
    from sales_order AS so
    LEFT JOIN (SELECT sales_order_id,lot_number FROM sales_order_details GROUP BY sales_order_id)AS sod ON (so.sales_order_id = sod.sales_order_id)
    where state = 1 and is_delete =0
  </select>

  <select id="selectPdaOutboundGoodsTaskListCount" resultType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select COUNT(so.sales_order_id)
    from sales_order AS so
    LEFT JOIN (SELECT sales_order_id,lot_number FROM sales_order_details GROUP BY sales_order_id)AS sod ON (so.sales_order_id = sod.sales_order_id)
    where state = 1 and is_delete =0
  </select>

  <update id="updateSaleOrderState">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sales_order
    set
    `state` = #{state,jdbcType=TINYINT},
    update_time = now()
    where sales_order_id = #{salesOrderId,jdbcType=INTEGER}
  </update>

</mapper>